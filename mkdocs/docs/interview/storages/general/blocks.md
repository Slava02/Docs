# Блокировки

**Классная статья:** https://zelark.github.io/exploring-query-locks-in-postgres/

Блокировки (locks) упорядочивают конкурентный доступ к разделяемым ресурсам.

Основные факторы влияющие на эффективность блокировок:

- Гранулярность (степень детализации блокировки)
Чем выше гранулярность - тем больше блокировок и тем больше нужно ресурсов для их обслуживания

- Набор режимов захвата
Основные - исключетельный и разделяемый. 

Чем меньше гранулярность и больше режимов - тем больше возможностей для распараллеливания

Также, блокировки делятся по времени использования:

- Длительные
Захватываются обычно до конца транзакции и, чаще всего, связаны с отношениями и строками

- Короткие
Буквально на несколько инструкций процессора, ими постгря управляет полностью сама


В Postgresql мы можем влиять на:

**Блокировки на уровне таблицы**

- ACCESS SHARE:  SELECT
- ROW SHARE: SELECT FOR UPDATE и SELECT FOR SHARE
- ROW EXCLUSIVE: UPDATE, DELETE и INSERT
- ACCESS EXCLUSIVE: DROP TABLE, TRUNCATE, REINDEX, CLUSTER, VACUUM FULL и

**Блокировки на уровне строки**

Благодаря изоляции на основе снимков табличные строки не требуется блокировать при чтении. Но нельзя допустить, чтобы две транзакции изменяли одну и ту же строку в один момент времени.

В PostgreSQL информация о том, что строка заблокирована, хранится только в заголовке версии строки.
Реализовано это просто: при попытке изменить строку с незавршенной xmax транзакцией - блокируемс до завершения данной транзакции. 

Существует четыре режима, в которых можно заблокировать строку: два исключительных и два разделяемых

- FOR UPDATE
- FOR NO KEY UPDATE

FOR UPDATE блокирует строки, полученные оператором SELECT, как для изменения. Это предотвращает их блокировку, изменение или удаление другими транзакциями до завершения текущей транзакции. Другие транзакции, которые пытаются выполнить UPDATE, DELETE, SELECT FOR UPDATE, SELECT FOR NO KEY UPDATE, SELECT FOR SHARE или SELECT FOR KEY SHARE этих строк, будут заблокированы до завершения текущей транзакции. В рамках транзакции Repeatable read или Serializable ошибка будет выдана, если блокируемая строка изменилась с момента начала транзакции

- FOR SHARE
- FOR KEY SHARE

Работает аналогично FOR NO KEY UPDATE, за исключением того, что получает разделяемую, а не исключительную блокировку для каждой обрабатываемрой строки.


**Мультитранзакции**

Признак блокировки представлен номером блокирующей транзакции в поле xmax, но разделяемые блокировки могут удерживаться несколькими транзакциями одновременно. Как в одно поле записать сразу несколько номеров?

Для разделяемых блокировок применяются так называемые мультитранзакции. Мультитранзакция — это группа транзакций, которой присвоен отдельный номер. 
